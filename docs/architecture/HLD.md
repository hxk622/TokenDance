# TokenDance æŠ€æœ¯æ¶æ„è®¾è®¡ - é«˜å±‚è®¾è®¡ (HLD)

> Version: 1.2.0 | MVPé˜¶æ®µ
> Last Updated: 2026-01-12

## 1. æ¶æ„æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

TokenDanceæ˜¯ä¸€ä¸ªé€šç”¨AI Agentå¹³å°ï¼ŒæŠ€æœ¯æ¶æ„éœ€è¦æ»¡è¶³ä»¥ä¸‹æ ¸å¿ƒç›®æ ‡ï¼š

| ç›®æ ‡ | æè¿° | å…³é”®æŒ‡æ ‡ |
|-----|------|---------|
| **Tokenæ•ˆç‡** | æœ€å¤§åŒ–åˆ©ç”¨context windowï¼Œæœ€å°åŒ–tokenæ¶ˆè€— | å•ä»»åŠ¡tokenæ¶ˆè€—é™ä½50%+ |
| **å“åº”é€Ÿåº¦** | åˆ©ç”¨KV Cacheå®ç°å¿«é€Ÿå“åº” | é¦–å­—å»¶è¿Ÿ < 500ms |
| **å¯æ‰©å±•æ€§** | Skillå¯æ’æ‹”ï¼Œå·¥å…·å¯æ‰©å±• | æ–°å¢Skillæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç  |
| **å¯é æ€§** | ä»»åŠ¡å¯æ¢å¤ï¼Œç»“æœå¯éªŒè¯ | ä»»åŠ¡æˆåŠŸç‡ > 95% |
| **å®‰å…¨æ€§** | ä»£ç æ‰§è¡Œéš”ç¦»ï¼Œæ•°æ®ç§Ÿæˆ·éš”ç¦» | é›¶å®‰å…¨äº‹æ•… |

### 1.2 æ ¸å¿ƒæ¶æ„åŸåˆ™

åŸºäºManusã€GenSparkç­‰äº§å“çš„æœ€ä½³å®è·µï¼Œæˆ‘ä»¬éµå¾ªä»¥ä¸‹æ¶æ„åŸåˆ™ï¼š

#### 1.2.0 å¤šç§Ÿæˆ·éš”ç¦»ï¼ˆMulti-Tenancy Isolationï¼‰ğŸ†• â­
- **ä¸‰å±‚ç§Ÿæˆ·æ¨¡å‹**ï¼šOrganization â†’ Team â†’ Workspace
- **ç‰©ç†éš”ç¦»**ï¼šFileSystem æŒ‰ Org/Team/Workspace åˆ†å±‚ç›®å½•
- **é€»è¾‘éš”ç¦»**ï¼šPostgreSQL RLS + Redis å‘½åç©ºé—´
- **KV-Cache éš”ç¦»**ï¼šæ¯ä¸ª Org ç‹¬ç«‹ Global Prefixï¼ŒTeam å…±äº« Skill Cache
- **èµ„æºé…é¢**ï¼šæŒ‰ Organization åˆ†é…å’Œè¿½è¸ªèµ„æºä½¿ç”¨é‡
- å‚è€ƒï¼š[Multi-Tenancy è®¾è®¡](./Multi-Tenancy.md)

#### 1.2.1 Plan Recitationï¼ˆç›®æ ‡èƒŒè¯µï¼‰
- æ¯æ¬¡Agentå¾ªç¯å°†å½“å‰TODOæ¸…å•è¿½åŠ åˆ°contextæœ«å°¾
- é˜²æ­¢é•¿ä»»åŠ¡ä¸­çš„"Lost-in-the-Middle"é—®é¢˜
- ç¡®ä¿Agentå§‹ç»ˆèšç„¦æ ¸å¿ƒç›®æ ‡

#### 1.2.2 Keep the Failuresï¼ˆä¿ç•™é”™è·¯ï¼‰
- å¤±è´¥çš„å°è¯•å’Œå †æ ˆè¿½è¸ªä¿ç•™åœ¨contextä¸­
- è®©Agentå½¢æˆ"å…ˆéªŒé¿å‘"èƒ½åŠ›
- ä»é”™è¯¯ä¸­å­¦ä¹ æ˜¯æ™ºèƒ½çš„æ ¸å¿ƒæ ‡å¿—

#### 1.2.3 KV Caching Stabilityï¼ˆå‰ç¼€ç¨³å®šï¼‰â­
- System Promptä¿æŒå›ºå®šä¸å˜
- æ‰€æœ‰å·¥å…·å®šä¹‰åœ¨åˆå§‹åŒ–æ—¶ä¸€æ¬¡æ€§åŠ è½½
- ä¸åœ¨å¼€å¤´æ’å…¥æ—¶é—´æˆ³/åŠ¨æ€ID
- ç›®æ ‡ï¼šKV-Cache å‘½ä¸­ç‡ > 90%

#### 1.2.4 Append-Only Context Growthï¼ˆçº¯è¿½åŠ ä¸Šä¸‹æ–‡ï¼‰ğŸ†• â­
- Context åªè¿½åŠ ï¼Œæ°¸ä¸ä¿®æ”¹å·²æœ‰å†…å®¹
- æ¯è½®å¯¹è¯è¿½åŠ æ–°å†…å®¹ï¼šæ€è€ƒ + å·¥å…·è°ƒç”¨ + ç»“æœ
- ä¿è¯ KV-Cache æŒç»­æœ‰æ•ˆï¼Œé¿å…é‡å¤è®¡ç®—
- æ€§èƒ½æå‡ï¼š7x fasterï¼ˆç›¸æ¯”æ¯è½®é‡æ„ contextï¼‰

#### 1.2.5 Structured Tagsï¼ˆç»“æ„åŒ–æ ‡è®°ï¼‰ğŸ†•
- ä½¿ç”¨æ˜ç¡®çš„æ ‡è®°åŒºåˆ†ä¸åŒç±»å‹çš„å†…å®¹
- æ ‡è®°ç³»ç»Ÿï¼šSYSTEM, TOOLS, USER, REASONING, TOOL_CALL, TOOL_RESULT, FINAL_ANSWER
- ä¾¿äºæ¨¡å‹ç†è§£è¯­ä¹‰è¾¹ç•Œ
- ä¾¿äºç³»ç»Ÿè§£æå’Œç¼“å­˜ç®¡ç†

#### 1.2.6 Tool Definition Maskingï¼ˆå·¥å…·å®šä¹‰æ©ç ï¼‰ğŸ†•
- æ‰€æœ‰å·¥å…·å®šä¹‰åœ¨åˆå§‹åŒ–æ—¶åŠ è½½ï¼ˆå›ºå®šå‰ç¼€çš„ä¸€éƒ¨åˆ†ï¼‰
- é€šè¿‡ Attention Mask æ§åˆ¶æŸäº›å·¥å…·çš„å¯è§æ€§
- å·¥å…·å®šä¹‰æ°¸è¿œåœ¨ context ä¸­ï¼ŒKV-Cache 100% å‘½ä¸­
- é€šè¿‡æ©ç æŠ€æœ¯è®©æ¨¡å‹"çœ‹ä¸è§"ä¸å¯ç”¨çš„å·¥å…·

#### 1.2.7 Controlled Randomnessï¼ˆå—æ§éšæœºï¼‰
- æ£€æµ‹åˆ°é‡å¤åŠ¨ä½œæ—¶å¼•å…¥ç»“æ„åŒ–å˜åŒ–
- æ‰“ç ´æ³¨æ„åŠ›å›ºå®šæ¨¡å¼
- é¿å…æ­»å¾ªç¯

#### 1.2.8 Dual Context Streamsï¼ˆåŒé‡åˆ†èº«ï¼‰
- Working Memoryï¼šç²¾ç®€æ‘˜è¦ç»™LLMå†³ç­–
- File Systemï¼šå…¨é‡åŸå§‹æ•°æ®æŒä¹…åŒ–
- ç±»ä¼¼äººç±»çš„çŸ­æœŸ/é•¿æœŸè®°å¿†åˆ†ç¦»

#### 1.2.9 Action Space Pruningï¼ˆå·¥å…·ç²¾ç®€ï¼‰
- æä¾›å°‘æ•°é«˜æ³›åŒ–å·¥å…·ï¼Œè€Œéå¤§é‡å‚ç›´API
- Agentå¯åœ¨æ²™ç®±ä¸­æ ¹æ®éœ€æ±‚è‡ªå»ºå·¥å…·
- å‡å°‘æ¨¡å‹çš„é€‰æ‹©å›°éš¾

#### 1.2.10 3-File Working Memory Patternï¼ˆä¸‰æ–‡ä»¶å·¥ä½œæ³•ï¼‰ğŸ†• â­â­â­
**æ¥æº**ï¼šManus Agent æ ¸å¿ƒæ¶æ„åŸåˆ™ï¼Œå·²è¢«éªŒè¯æœ‰æ•ˆ

**æ ¸å¿ƒç†å¿µ**ï¼šåˆ©ç”¨æŒä¹…åŒ– Markdown æ–‡ä»¶ä½œä¸º Agent çš„"å·¥ä½œè®°å¿†"ï¼Œè€Œä¸æ˜¯å®Œå…¨ä¾èµ–è„†å¼±ä¸”æ˜‚è´µçš„ Context Window

**ä¸‰ä¸ªæ ¸å¿ƒæ–‡ä»¶**ï¼š
1. **task_plan.mdï¼ˆè·¯çº¿å›¾ï¼‰**
   - ä½œç”¨ï¼šä»»åŠ¡æ‹†è§£ï¼ŒAI å¿…é¡»å…ˆå†™å¥½ Phase 1, Phase 2... çš„è®¡åˆ’
   - å…³é”®æœºåˆ¶ï¼šSessionStart å’Œ PreToolUse é’©å­å¼ºåˆ¶ AI "é‡è¯»"è®¡åˆ’
   - é˜²æ­¢ï¼šContext Driftï¼ˆä¸Šä¸‹æ–‡æ¼‚ç§»ï¼‰

2. **findings.mdï¼ˆçŸ¥è¯†åº“ï¼‰**
   - ä½œç”¨ï¼šå­˜å‚¨ç ”ç©¶å‘ç°å’ŒæŠ€æœ¯å†³ç­–
   - å…³é”®æœºåˆ¶ï¼š**2-Action Rule** - æ¯è¿›è¡Œä¸¤æ¬¡æœç´¢/æµè§ˆæ“ä½œï¼ŒAI å¿…é¡»å°†å‘ç°å­˜å…¥æ­¤æ–‡ä»¶
   - æ”¶ç›Šï¼šæå¤§èŠ‚çœ Tokenï¼Œé¿å…ä¸Šä¸‹æ–‡çˆ†ç‚¸

3. **progress.mdï¼ˆæ‰§è¡Œæ—¥å¿—ï¼‰**
   - ä½œç”¨ï¼šè®°å½•æ‰§è¡Œè¿‡ç¨‹å’Œæµ‹è¯•ç»“æœ
   - å…³é”®æœºåˆ¶ï¼š**å¼ºåˆ¶è®°å½•æ‰€æœ‰é”™è¯¯**
   - æ”¶ç›Šï¼šé˜²æ­¢ AI åœ¨åŒä¸€ä¸ªå‘é‡Œåå¤æ‘”å€’ï¼ˆä¸é‡å¤å¤±è´¥åŸåˆ™ï¼‰

**é…å¥—è¡Œä¸ºè§„åˆ™**ï¼š
- **2-Action Ruleï¼ˆ2æ¬¡è¡ŒåŠ¨è§„åˆ™ï¼‰**ï¼šæ“ä½œä¸¤æ¬¡å¿…è®°å½•ï¼Œé˜²æ­¢ä¸Šä¸‹æ–‡çˆ†ç‚¸
- **3-Strike Protocolï¼ˆ3æ¬¡æ‰“å‡»åè®®ï¼‰**ï¼šåŒç±»é”™è¯¯å‡ºç°3æ¬¡ï¼Œå¿…é¡»åœä¸‹æ¥é‡è¯»è®¡åˆ’å¹¶é‡æ–°å®¡è§†æ–¹æ³•è®º
- **5-Question Reboot Testï¼ˆ5é—®é‡å¯æµ‹è¯•ï¼‰**ï¼šAgent è¿·èŒ«æ—¶é€šè¿‡5ä¸ªé—®é¢˜è‡ªæˆ‘æ£€æµ‹ï¼Œé‡æ–°æ‰¾å›ç›®æ ‡

**æŠ€æœ¯ä¼˜åŠ¿**ï¼š
- Token æ¶ˆè€—é™ä½ 60-80%ï¼ˆç›¸æ¯”å…¨éƒ¨å¡å…¥ Contextï¼‰
- é•¿ä»»åŠ¡æˆåŠŸç‡æå‡ 40%+ï¼ˆManus å®æµ‹æ•°æ®ï¼‰
- å®Œç¾æ”¯æŒè·¨ Session æ¢å¤ï¼ˆæ–‡ä»¶æŒä¹…åŒ–ï¼‰
- ä¸ Plan Recitationã€Keep the Failures åŸåˆ™æ— ç¼é…åˆ

**å®æ–½è¦ç‚¹**ï¼š
- ä¸‰ä¸ªæ–‡ä»¶å­˜å‚¨åœ¨ Workspace FileSystem ä¸­
- æ¯ä¸ª Session ç‹¬ç«‹ç›®å½•ï¼š`/workspace/{org_id}/{team_id}/{workspace_id}/{session_id}/`
- Agent åœ¨å…³é”®å†³ç­–ç‚¹ï¼ˆå·¥å…·è°ƒç”¨å‰ã€é”™è¯¯å‘ç”Ÿåï¼‰å¿…é¡»è¯»å–/æ›´æ–°æ–‡ä»¶
- å‰ç«¯ UI éœ€è¦å±•ç¤º"Working Memory"æ ‡ç­¾é¡µï¼Œå®æ—¶æ˜¾ç¤ºä¸‰æ–‡ä»¶å†…å®¹

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Client Layer                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    Vue3 + TypeScript + Tailwind                  â”‚    â”‚
â”‚  â”‚    [Manus Home]  [Chat UI]  [Working Memory]  [Artifact View]    â”‚    â”‚
â”‚  â”‚    - æ„å›¾å¡ç‰‡   - SSE Stream  - ä¸‰æ–‡ä»¶å¯è§†åŒ–  - PPT/Report      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ REST / SSE / WebSocket
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          API Gateway (FastAPI)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  [Tenant Auth] [JWT] [Rate Limit] [Router] [SSE Manager]         â”‚    â”‚
â”‚  â”‚  - å¤šç§Ÿæˆ·é‰´æƒ  - RBAC   - é…é¢æ£€æŸ¥  - è·¯ç”±åˆ†å‘ - æµå¼æ¨é€      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                   â”‚                   â”‚               â”‚
                  â–¼                   â–¼                   â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Agent Engine     â”‚  â”‚  Skill System  â”‚  â”‚  Tool System   â”‚  â”‚  MCP   â”‚
    â”‚  (æ ¸å¿ƒå†³ç­–å¾ªç¯)     â”‚  â”‚  (ä¸‰çº§æ‡’åŠ è½½)   â”‚  â”‚  (å·¥å…·æ³¨å†Œè¡¨)   â”‚  â”‚ Bridge â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                     â”‚                   â”‚
              â”‚                     â”‚                   â”‚
              â–¼                     â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              Agent Engine Core                           â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  Execution Loop (SSE Stream)                       â”‚  â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
    â”‚  â”‚  â”‚  1. Plan Recitation (èƒŒè¯µç›®æ ‡)            â”‚    â”‚  â”‚
    â”‚  â”‚  â”‚  2. Context Assembly (ç»„è£…Prompt)        â”‚    â”‚  â”‚
    â”‚  â”‚  â”‚  3. LLM Inference (æ¨ç†)                  â”‚    â”‚  â”‚
    â”‚  â”‚  â”‚  4. Tool Call Parsing (è§£æå·¥å…·è°ƒç”¨)      â”‚    â”‚  â”‚
    â”‚  â”‚  â”‚  5. Tool Execution (æ‰§è¡Œ)                 â”‚    â”‚  â”‚
    â”‚  â”‚  â”‚  6. Result Validation (éªŒè¯)              â”‚    â”‚  â”‚
    â”‚  â”‚  â”‚  7. Memory Update (æ›´æ–°)                  â”‚    â”‚  â”‚
    â”‚  â”‚  â”‚  8. SSE Push (æµå¼æ¨é€)                   â”‚    â”‚  â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                     â”‚                   â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
     â–¼                 â–¼   â–¼                 â–¼  â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Context â”‚  â”‚   Memory    â”‚  â”‚  Skill   â”‚  â”‚  Tool   â”‚  â”‚Sandbox â”‚
â”‚ Manager â”‚  â”‚   System    â”‚  â”‚  System  â”‚  â”‚ Registryâ”‚  â”‚Manager â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚              â”‚              â”‚             â”‚           â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚              â”‚             â”‚
                    â–¼              â–¼             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚            Storage & Infrastructure Layer              â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚PostgreSQLâ”‚  â”‚  Redis   â”‚  â”‚  MinIO   â”‚  â”‚ Docker â”‚ â”‚
    â”‚  â”‚+ pgvectorâ”‚  â”‚KV Cache  â”‚  â”‚ Storage  â”‚  â”‚Sandbox â”‚ â”‚
    â”‚  â”‚+ RLS     â”‚  â”‚+ Namespaceâ”‚ â”‚FileSystemâ”‚  â”‚  Pod   â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              External Services Layer                   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
    â”‚  â”‚ Claude   â”‚  â”‚  Gemini  â”‚  â”‚  Tavily  â”‚             â”‚
    â”‚  â”‚   API    â”‚  â”‚   API    â”‚  â”‚   API    â”‚             â”‚
    â”‚  â”‚(ä¸»æ¨¡å‹)  â”‚  â”‚(å¤‡é€‰)    â”‚  â”‚(æœç´¢)    â”‚             â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 åç«¯æ¨¡å—ç»“æ„

```
backend/app/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ main.py                    # FastAPI åº”ç”¨å…¥å£
â”‚
â”œâ”€â”€ api/                       # API å±‚
â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â”œâ”€â”€ auth.py           # è®¤è¯ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ chat.py           # å¯¹è¯æ¥å£ (SSE)
â”‚   â”‚   â”œâ”€â”€ workspace.py      # å·¥ä½œåŒºç®¡ç†
â”‚   â”‚   â”œâ”€â”€ task.py           # ä»»åŠ¡ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ file.py           # æ–‡ä»¶æ“ä½œ
â”‚   â”‚   â””â”€â”€ skill.py          # Skill ç®¡ç†
â”‚   â””â”€â”€ deps.py               # ä¾èµ–æ³¨å…¥
â”‚
â”œâ”€â”€ agent/                     # Agent Engine æ ¸å¿ƒ
â”‚   â”œâ”€â”€ base.py               # Agent æŠ½è±¡åŸºç±»
â”‚   â”œâ”€â”€ engine.py             # æ‰§è¡Œå¼•æ“ï¼ˆå†³ç­–å¾ªç¯ï¼‰
â”‚   â”œâ”€â”€ executor.py           # å·¥å…·æ‰§è¡Œå™¨
â”‚   â”œâ”€â”€ context.py            # Context ç®¡ç†
â”‚   â”œâ”€â”€ context_manager.py    # Context ç»„è£…ä¸å‹ç¼©
â”‚   â”œâ”€â”€ memory.py             # Working Memory
â”‚   â”œâ”€â”€ planning/             # è§„åˆ’æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ planner.py        # ä»»åŠ¡è§„åˆ’
â”‚   â”‚   â”œâ”€â”€ recitation.py     # Plan Recitation
â”‚   â”‚   â””â”€â”€ three_files.py    # ä¸‰æ–‡ä»¶å·¥ä½œæ³•
â”‚   â”œâ”€â”€ tools/                # å·¥å…·ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ base.py           # Tool åŸºç±»
â”‚   â”‚   â”œâ”€â”€ registry.py       # å·¥å…·æ³¨å†Œè¡¨
â”‚   â”‚   â””â”€â”€ builtin/          # å†…ç½®å·¥å…·
â”‚   â”‚       â”œâ”€â”€ web_search.py
â”‚   â”‚       â”œâ”€â”€ read_url.py
â”‚   â”‚       â”œâ”€â”€ file_ops.py
â”‚   â”‚       â””â”€â”€ code_execute.py
â”‚   â”œâ”€â”€ llm/                  # LLM å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ base.py
â”‚   â”‚   â”œâ”€â”€ anthropic.py      # Claude API
â”‚   â”‚   â””â”€â”€ gemini.py         # Gemini API
â”‚   â””â”€â”€ working_memory/       # Working Memory å®ç°
â”‚       â””â”€â”€ manager.py
â”‚
â”œâ”€â”€ skills/                    # Skill ç³»ç»Ÿ
â”‚   â”œâ”€â”€ __init__.py           # ç»Ÿä¸€å¯¼å‡º
â”‚   â”œâ”€â”€ types.py              # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ registry.py           # Skill æ³¨å†Œè¡¨ï¼ˆL1ï¼‰
â”‚   â”œâ”€â”€ matcher.py            # Skill åŒ¹é…å™¨ï¼ˆå…³é”®è¯+Embedding+LLMï¼‰
â”‚   â”œâ”€â”€ loader.py             # Skill åŠ è½½å™¨ï¼ˆL2/L3ï¼‰
â”‚   â”œâ”€â”€ embedding.py          # Embedding æ¨¡å—ï¼ˆsentence-transformersï¼‰
â”‚   â””â”€â”€ builtin/              # å†…ç½® Skill
â”‚       â”œâ”€â”€ deep_research/    # æ·±åº¦ç ”ç©¶ Skill
â”‚       â”‚   â”œâ”€â”€ SKILL.md      # L1+L2 å®šä¹‰
â”‚       â”‚   â””â”€â”€ resources/    # L3 èµ„æº
â”‚       â”œâ”€â”€ ppt/              # PPT ç”Ÿæˆ Skill
â”‚       â””â”€â”€ coworker/         # æœ¬åœ°æ–‡ä»¶æ“æ§ Skill
â”‚
â”œâ”€â”€ core/                      # æ ¸å¿ƒæœåŠ¡
â”‚   â”œâ”€â”€ config.py             # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ security.py           # å®‰å…¨è®¤è¯
â”‚   â”œâ”€â”€ database.py           # æ•°æ®åº“è¿æ¥
â”‚   â””â”€â”€ tenant.py             # ğŸ†• å¤šç§Ÿæˆ·ç®¡ç†
â”‚
â”œâ”€â”€ models/                    # æ•°æ®åº“æ¨¡å‹
â”‚   â”œâ”€â”€ user.py
â”‚   â”œâ”€â”€ workspace.py
â”‚   â”œâ”€â”€ session.py
â”‚   â”œâ”€â”€ message.py
â”‚   â”œâ”€â”€ task.py
â”‚   â”œâ”€â”€ skill.py              # Skill ç»Ÿè®¡ç¼“å­˜
â”‚   â””â”€â”€ tenant.py             # ğŸ†• ç§Ÿæˆ·æ¨¡å‹
â”‚
â”œâ”€â”€ schemas/                   # Pydantic Schemas
â”‚   â”œâ”€â”€ auth.py
â”‚   â”œâ”€â”€ chat.py
â”‚   â”œâ”€â”€ workspace.py
â”‚   â””â”€â”€ skill.py
â”‚
â”œâ”€â”€ services/                  # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ auth_service.py
â”‚   â”œâ”€â”€ workspace_service.py
â”‚   â”œâ”€â”€ session_service.py
â”‚   â””â”€â”€ tenant_service.py     # ğŸ†• ç§Ÿæˆ·æœåŠ¡
â”‚
â”œâ”€â”€ repositories/              # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ user_repo.py
â”‚   â”œâ”€â”€ workspace_repo.py
â”‚   â”œâ”€â”€ session_repo.py
â”‚   â””â”€â”€ tenant_repo.py        # ğŸ†• ç§Ÿæˆ·ä»“å‚¨
â”‚
â”œâ”€â”€ filesystem/                # æ–‡ä»¶ç³»ç»Ÿç®¡ç†
â”‚   â”œâ”€â”€ manager.py            # æ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨
â”‚   â”œâ”€â”€ workspace_fs.py       # Workspace æ–‡ä»¶ç³»ç»Ÿ
â”‚   â””â”€â”€ three_files.py        # ä¸‰æ–‡ä»¶å·¥ä½œæ³•å®ç°
â”‚
â”œâ”€â”€ mcp/                       # MCP (Model Context Protocol)
â”‚   â”œâ”€â”€ server.py             # MCP Server
â”‚   â”œâ”€â”€ bridge.py             # MCP Bridge
â”‚   â””â”€â”€ tools/                # MCP å·¥å…·é€‚é…å™¨
â”‚
â””â”€â”€ db/
    â””â”€â”€ migrations/            # Alembic è¿ç§»è„šæœ¬
```

### 2.3 æ¨¡å—èŒè´£

| æ¨¡å— | èŒè´£ | å…³é”®æ¥å£ | ä¾èµ– |
|-----|------|---------|------|
| **API Gateway** | REST APIã€SSE æµå¼æ¨é€ã€å¤šç§Ÿæˆ·é‰´æƒã€é™æµ | `/api/v1/chat`, `/api/v1/workspace` | FastAPI |
| **Tenant Manager** | ğŸ†• ç»„ç»‡/å›¢é˜Ÿ/å·¥ä½œåŒºç®¡ç†ã€æƒé™æ£€æŸ¥ã€é…é¢æ§åˆ¶ | `check_permission()`, `check_quota()` | PostgreSQL RLS |
| **Agent Engine** | æ ¸å¿ƒå†³ç­–å¾ªç¯ã€SSE æµå¼è¾“å‡ºã€å·¥å…·è°ƒç”¨ç¼–æ’ | `run()`, `step()`, `stream()` | LLM, Tools, Skill |
| **Skill System** | ä¸‰çº§æ‡’åŠ è½½ï¼ˆL1/L2/L3ï¼‰ã€æ„å›¾åŒ¹é…ã€èµ„æºåŠ è½½ | `match()`, `load_l2()`, `load_l3()` | sentence-transformers |
| **Tool System** | å·¥å…·æ³¨å†Œã€æ‰§è¡Œã€æ²™ç®±éš”ç¦» | `register()`, `execute()` | Docker, MCP |
| **Context Manager** | Token é¢„ç®—ã€è‡ªåŠ¨å‹ç¼©ã€KV-Cache ä¼˜åŒ– | `assemble()`, `compress()` | Redis, Memory |
| **Memory System** | Working Memoryã€Episode Memoryã€Long-term Memory | `store()`, `retrieve()` | PostgreSQL, FileSystem |
| **Sandbox Manager** | Docker å®¹å™¨ç”Ÿå‘½å‘¨æœŸã€èµ„æºé™åˆ¶ | `create()`, `execute()`, `destroy()` | Docker API |
| **MCP Bridge** | MCP åè®®é€‚é…ã€å¤–éƒ¨å·¥å…·é›†æˆ | `register_tool()`, `call_tool()` | MCP Protocol |
| **FileSystem Manager** | ä¸‰æ–‡ä»¶å·¥ä½œæ³•ã€Workspace æ–‡ä»¶ç®¡ç† | `read_file()`, `write_file()` | MinIO, Local FS |

## 3. æŠ€æœ¯é€‰å‹

### 3.1 æŠ€æœ¯æ ˆæ€»è§ˆ

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|-----|---------|-----|
| **å‰ç«¯** | Vue 3 + TypeScript | å“åº”å¼æ¡†æ¶ |
| **UIç»„ä»¶** | Shadcn/UI Vue + Tailwind | ç°ä»£UIç»„ä»¶åº“ |
| **çŠ¶æ€ç®¡ç†** | Pinia | Vueå®˜æ–¹æ¨è |
| **åç«¯æ¡†æ¶** | FastAPI | é«˜æ€§èƒ½å¼‚æ­¥æ¡†æ¶ |
| **ä»»åŠ¡é˜Ÿåˆ—** | Celery + Redis | å¼‚æ­¥ä»»åŠ¡å¤„ç† |
| **ä¸»æ•°æ®åº“** | PostgreSQL + pgvector + RLS | å…³ç³»æ•°æ® + å‘é‡å­˜å‚¨ + è¡Œçº§å®‰å…¨ ğŸ†• |
| **KV-Cache** | Redis | KV-Cache æŒä¹…åŒ–ï¼ˆæ”¯æŒ RDB/AOFï¼‰ğŸ†• |
| **å‘é‡æ•°æ®åº“** | Milvus | Skill åŒ¹é…ã€æ€ç»´å¿«ç…§æ£€ç´¢ ğŸ†• |
| **å¯¹è±¡å­˜å‚¨** | MinIO | æ–‡ä»¶ã€äº§å‡ºç‰©å­˜å‚¨ |
| **æ²™ç®±** | Docker | ä»£ç æ‰§è¡Œéš”ç¦» |
| **æµè§ˆå™¨è‡ªåŠ¨åŒ–** | agent-browser | Vercel Labs å‡ºå“ï¼ŒSnapshot + Refs æ¨¡å¼ï¼ŒèŠ‚çœ 93% Token ğŸ†• |
| **LLM** | Claude API / Gemini API | ä¸»æ¨ç†å¼•æ“ |
| **æœç´¢** | Tavily API | Webæœç´¢æœåŠ¡ |

### 3.2 å…³é”®æŠ€æœ¯å†³ç­–

#### ä¸ºä»€ä¹ˆé€‰æ‹© FastAPIï¼Ÿ
- åŸç”Ÿå¼‚æ­¥æ”¯æŒï¼Œé€‚åˆI/Oå¯†é›†å‹Agentåœºæ™¯
- è‡ªåŠ¨OpenAPIæ–‡æ¡£ç”Ÿæˆ
- ç±»å‹æç¤ºå‹å¥½ï¼Œä»£ç å¯ç»´æŠ¤æ€§é«˜
- WebSocketåŸç”Ÿæ”¯æŒ

#### ä¸ºä»€ä¹ˆé€‰æ‹© PostgreSQL + pgvectorï¼Ÿ
- äº‹åŠ¡æ”¯æŒï¼Œæ•°æ®ä¸€è‡´æ€§ä¿è¯
- pgvectoræ‰©å±•æä¾›å‘é‡å­˜å‚¨ï¼Œæ— éœ€é¢å¤–å‘é‡æ•°æ®åº“
- å•ä¸€æ•°æ®åº“ç®€åŒ–è¿ç»´

#### ä¸ºä»€ä¹ˆé€‰æ‹© Dockerä½œä¸ºæ²™ç®±ï¼Ÿ
- æˆç†Ÿç¨³å®šï¼Œç”Ÿæ€å®Œå–„
- èµ„æºéš”ç¦»å’Œé™åˆ¶èƒ½åŠ›å¼º
- å¿«é€Ÿå¯åŠ¨ï¼ˆç›¸æ¯”VMï¼‰
- å¯æ‰©å±•è‡³Kubernetes

#### ä¸ºä»€ä¹ˆé€‰æ‹© agent-browserï¼ŸğŸ†•
- **93% Token èŠ‚çœ**ï¼šSnapshot + Refs æ¨¡å¼ vs Playwright MCP å®Œæ•´ Accessibility Tree
- **ç¡®å®šæ€§å…ƒç´ é€‰æ‹©**ï¼š@e1, @e2 å¼•ç”¨æ¨¡å¼ï¼Œæ¯” CSS Selector æ›´ç¨³å®š
- **åŸç”Ÿ Session éš”ç¦»**ï¼šæ”¯æŒå¤š Agent å¹¶å‘æ“ä½œä¸åŒæµè§ˆå™¨å®ä¾‹
- **Rust + Node.js æ··åˆæ¶æ„**ï¼šå¿«é€Ÿå¯åŠ¨ï¼Œé«˜æ€§èƒ½
- **ä¸ TokenDance åŸåˆ™å¥‘åˆ**ï¼šå®Œç¾åŒ¹é… Dual Context Streamsã€ä¸‰æ–‡ä»¶å·¥ä½œæ³•
- **é™çº§æ–¹æ¡ˆ**ï¼šæŠ½è±¡æœåŠ¡å±‚è®¾è®¡ï¼Œå¯åˆ‡æ¢å› Playwright

## 4. å¤šç§Ÿæˆ·æ¶æ„

### 4.1 ä¸‰å±‚ç§Ÿæˆ·æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç§Ÿæˆ·å±‚çº§ï¼šOrganization â†’ Team â†’ Workspace              â”‚
â”‚                                                            â”‚
â”‚  Organization (ç»„ç»‡/ä¼ä¸š)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ è®¡è´¹å•å…ƒï¼šç»Ÿä¸€è®¡è´¹                                â”‚  â”‚
â”‚  â”‚ â€¢ èµ„æºé…é¢ï¼šmax_teams, max_workspaces, max_agents  â”‚  â”‚
â”‚  â”‚ â€¢ æ•°æ®éš”ç¦»ï¼šç‰©ç† + é€»è¾‘åŒé‡éš”ç¦»                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                                               â”‚
â”‚            â””â”€â”€â”€â”€â”€ Team (å›¢é˜Ÿ)                        â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                  â”‚ â€¢ åä½œå•å…ƒ                    â”‚  â”‚
â”‚                  â”‚ â€¢ å…±äº«èµ„æºï¼šçŸ¥è¯†åº“ã€æ¨¡æ¿    â”‚  â”‚
â”‚                  â”‚ â€¢ Team Skill Cache å…±äº«    â”‚  â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â”‚                             â”‚
â”‚                        â””â”€â”€â”€ Workspace (å·¥ä½œåŒº)   â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                            â”‚ â€¢ ç‹¬ç«‹å·¥ä½œç©ºé—´  â”‚  â”‚
â”‚                            â”‚ â€¢ Agents      â”‚  â”‚
â”‚                            â”‚ â€¢ Tasks       â”‚  â”‚
â”‚                            â”‚ â€¢ Files       â”‚  â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ•°æ®éš”ç¦»ç­–ç•¥

**ç‰©ç†éš”ç¦»ï¼ˆFileSystemï¼‰**ï¼š
```bash
/data/orgs/
â””â”€â”€ org-{org_id}/                    # Organization çº§åˆ«éš”ç¦»
    â”œâ”€â”€ .metadata
    â”œâ”€â”€ billing/
    â””â”€â”€ teams/
        â””â”€â”€ team-{team_id}/          # Team çº§åˆ«éš”ç¦»
            â”œâ”€â”€ shared/               # å›¢é˜Ÿå…±äº«èµ„æº
            â”‚   â”œâ”€â”€ knowledge_base/
            â”‚   â””â”€â”€ templates/
            â””â”€â”€ workspaces/
                â””â”€â”€ ws-{workspace_id}/  # Workspace çº§åˆ«éš”ç¦»
                    â”œâ”€â”€ tasks/
                    â”œâ”€â”€ context/
                    â”œâ”€â”€ cache/
                    â””â”€â”€ drafts/
```

**é€»è¾‘éš”ç¦»ï¼ˆDatabase + Redisï¼‰**ï¼š
- PostgreSQL RLSï¼šè¡Œçº§å®‰å…¨ç­–ç•¥
- Redis å‘½åç©ºé—´ï¼š`kv_cache:org:{org_id}:ws:{workspace_id}:session:{session_id}`

### 4.3 æƒé™çŸ©é˜µ

| èµ„æº | Owner | Admin | Member | Guest |
|------|-------|-------|--------| -------|
| **Organization** |
| æŸ¥çœ‹ | âœ… | âœ… | âœ… | âœ… |
| ä¿®æ”¹ | âœ… | âœ… | âŒ | âŒ |
| åˆ é™¤ | âœ… | âŒ | âŒ | âŒ |
| **Workspace** |
| åˆ›å»º | âœ… | âœ… | âœ… | âŒ |
| ç¼–è¾‘ | Owner/Editor | Owner/Editor | Owner/Editor | âŒ |
| æ‰§è¡Œä»»åŠ¡ | Owner/Editor | Owner/Editor | Owner/Editor | âŒ |
| æŸ¥çœ‹ | âœ… | âœ… | æŒ‰å¯è§æ€§ | Viewer |

è¯¦ç»†è®¾è®¡å‚è€ƒï¼š[Multi-Tenancy.md](./Multi-Tenancy.md)

---

## 5. æ•°æ®æµè®¾è®¡

### 5.1 ç”¨æˆ·è¯·æ±‚å¤„ç†æµç¨‹ï¼ˆå¤šç§Ÿæˆ·ï¼‰

```
ç”¨æˆ·è¾“å…¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Gateway          â”‚
â”‚  - JWT é‰´æƒ            â”‚
â”‚  - æå– org_id/team_id â”‚ ğŸ†•
â”‚  - å‚æ•°æ ¡éªŒ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tenant Manager       â”‚ ğŸ†•
â”‚  - æƒé™æ£€æŸ¥           â”‚
â”‚  - é…é¢æ£€æŸ¥           â”‚
â”‚  - èµ„æºéš”ç¦»           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Session Manager      â”‚
â”‚  - åŠ è½½ Workspace å†å² â”‚
â”‚  - åˆ›å»ºä¼šè¯           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Skill Router   â”‚â—„â”€â”€â”€ L1 å…ƒæ•°æ®åŒ¹é…
â”‚  - æ„å›¾è¯†åˆ«     â”‚
â”‚  - Skillé€‰æ‹©    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Skill Loader   â”‚â—„â”€â”€â”€ æŒ‰éœ€åŠ è½½ L2/L3
â”‚  - åŠ è½½æŒ‡ä»¤     â”‚
â”‚  - æ³¨å…¥Context  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Agent Loop                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         while not done:          â”‚    â”‚
â”‚  â”‚  1. Context Manager ç»„è£…prompt   â”‚    â”‚
â”‚  â”‚  2. LLM æ¨ç†                     â”‚    â”‚
â”‚  â”‚  3. è§£æTool Call               â”‚    â”‚
â”‚  â”‚  4. Tool Executor æ‰§è¡Œ          â”‚    â”‚
â”‚  â”‚  5. Validator éªŒè¯ç»“æœ          â”‚    â”‚
â”‚  â”‚  6. Memory æ›´æ–°                 â”‚    â”‚
â”‚  â”‚  7. Plan Recitation èƒŒè¯µç›®æ ‡    â”‚    â”‚
â”‚  â”‚  8. æµå¼è¾“å‡ºç»™å‰ç«¯              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response       â”‚
â”‚  - SSEæµå¼æ¨é€  â”‚
â”‚  - äº§å‡ºç‰©å­˜å‚¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Skill ç³»ç»Ÿé›†æˆæµç¨‹

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘            â‘  å¯åŠ¨æ—¶ï¼šSkill Registry åˆå§‹åŒ–            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  æ‰«æ skills/builtin/ ç›®å½•
       â”‚
       â–¼
  è§£ææ‰€æœ‰ SKILL.md çš„ YAML å¤´ (L1 å…ƒæ•°æ®)
       â”‚
       â–¼
  æ„å»º L1 å†…å­˜ç´¢å¼•
  - deep_research (æ·±åº¦ç ”ç©¶)
  - ppt_generation (PPTç”Ÿæˆ)
  - coworker (æœ¬åœ°æ–‡ä»¶)
       â”‚
       â–¼
  é¢„è®¡ç®— Skill Embedding (sentence-transformers)
       â”‚
       â–¼
  æ³¨å…¥ System Prompt (çº¦100 tokens/skill)
  """
  [Available Skills]
  - **æ·±åº¦ç ”ç©¶**: æ·±åº¦ç ”ç©¶èƒ½åŠ›ï¼Œæ”¯æŒå¤šæºæœç´¢...
  - **PPTç”Ÿæˆ**: æ™ºèƒ½æ¼”ç¤ºæ–‡ç¨¿ç”Ÿæˆ...
  """

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘             â‘¡ è¿è¡Œæ—¶ï¼šSkill åŒ¹é…ä¸åŠ è½½             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ç”¨æˆ·æ¶ˆæ¯: "å¸®æˆ‘è°ƒç ” AI Agent å¸‚åœº"
       â”‚
       â–¼
  SkillMatcher.match(message)
       â”‚
       â”œâ”€ Step 1: å…³é”®è¯åŒ¹é…
       â”‚   - æ£€æµ‹åˆ° tags: ["research", "è°ƒç ”"]
       â”‚   - å€™é€‰: [deep_research]
       â”‚
       â”œâ”€ Step 2: Embedding è¯­ä¹‰åŒ¹é…
       â”‚   - è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦: 0.87
       â”‚   - ç¡®è®¤å€™é€‰: deep_research
       â”‚
       â””â”€ Step 3: (Optional) LLM Rerank
           - æå‡ç²¾ç¡®åº¦è‡³ 0.92
       â”‚
       â–¼
  åŒ¹é…æˆåŠŸ: deep_research (score=0.92)
       â”‚
       â–¼
  SkillLoader.load_l2("deep_research")
       â”‚
       â–¼
  åŠ è½½ SKILL.md æ­£æ–‡ (L2 å®Œæ•´æŒ‡ä»¤)
  - èƒ½åŠ›æ¦‚è¿°
  - å·¥ä½œæµç¨‹ (Phase 1-7)
  - å·¥å…·ä½¿ç”¨æŒ‡å—
  - æœ€ä½³å®è·µ
  (çº¦ 4500 tokens)
       â”‚
       â–¼
  æ³¨å…¥ Agent Context
  - System Prompt ä¿æŒä¸å˜ (KV-Cache å‘½ä¸­)
  - L2 æŒ‡ä»¤è¿½åŠ åˆ° Context
       â”‚
       â–¼
  Action Space Pruning
  - è¿‡æ»¤å·¥å…·ï¼šåªä¿ç•™ [web_search, read_url, create_document]
  - éšè—å…¶ä»–å·¥å…·å®šä¹‰ (é€šè¿‡ Attention Mask)
       â”‚
       â–¼
  Agent å¼€å§‹æ‰§è¡Œ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          â‘¢ æ‰§è¡Œæ—¶ï¼šL3 èµ„æºæŒ‰éœ€åŠ è½½             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Agent æ‰§è¡Œè¿‡ç¨‹ä¸­...
       â”‚
       â”œâ”€ åœºæ™¯ 1ï¼šéœ€è¦ç”ŸæˆæŸ¥è¯¢
       â”‚    â–¼
       â”‚   execute_l3_script("query_generator.py", ["AI Agent", "deep"])
       â”‚    â”‚
       â”‚    â–¼
       â”‚   æ²™ç®±æ‰§è¡Œ Python è„šæœ¬
       â”‚    â”‚
       â”‚    â–¼
       â”‚   è¿”å› JSON: ["AI Agent market size 2024", ...]
       â”‚    â”‚
       â”‚    â–¼
       â”‚   Agent ä½¿ç”¨è¿™äº›æŸ¥è¯¢æ‰§è¡Œ web_search
       â”‚
       â”œâ”€ åœºæ™¯ 2ï¼šéœ€è¦æ‘˜è¦é•¿æ–‡
       â”‚    â–¼
       â”‚   load_l3_resource("summarize.md")
       â”‚    â”‚
       â”‚    â–¼
       â”‚   è¯»å–æ‘˜è¦å­æŠ€èƒ½æŒ‡å¯¼
       â”‚    â”‚
       â”‚    â–¼
       â”‚   Agent æŒ‰ç…§æŒ‡å¯¼å¤„ç†é•¿æ–‡
       â”‚
       â””â”€ åœºæ™¯ 3ï¼šéœ€è¦æŠ¥å‘Šæ¨¡æ¿
            â–¼
           load_l3_resource("report_template.md")
            â”‚
            â–¼
           è¯»å–æ¨¡æ¿ç»“æ„
            â”‚
            â–¼
           Agent æŒ‰æ¨¡æ¿ç”ŸæˆæŠ¥å‘Š

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å…³é”®ä¼˜ç‚¹ï¼š
1. L1 å…ƒæ•°æ®å§‹ç»ˆåœ¨å†…å­˜ï¼Œæ— éœ€é‡å¤åŠ è½½
2. L2 æŒ‡ä»¤åªåœ¨åŒ¹é…æ—¶åŠ è½½ï¼ŒèŠ‚çœ 90%+ Token
3. L3 èµ„æºæŒ‰éœ€åŠ è½½ï¼Œä¸å ç”¨ Context
4. Embedding è¯­ä¹‰åŒ¹é…æå‡å‡†ç¡®ç‡ï¼Œå…è´¹æœ¬åœ°æ–¹æ¡ˆ
5. Action Space Pruning å‡å°‘æ¨¡å‹é€‰æ‹©å›°éš¾
```

### 4.3 Contextç»„è£…æµç¨‹

```
Token Budget: 128K (Claude) / 1M (Gemini)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Context Window                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [å›ºå®š] System Prompt           (~2000 tokens)          â”‚
â”‚    - è§’è‰²å®šä¹‰                                            â”‚
â”‚    - è¡Œä¸ºå‡†åˆ™                                            â”‚
â”‚    - è¾“å‡ºæ ¼å¼                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [å›ºå®š] L1 Skill å…ƒæ•°æ®          (~100 * N tokens)      â”‚
â”‚    - æ‰€æœ‰å·²å®‰è£… Skill çš„ name + description             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [åŠ¨æ€] L2 Skill æŒ‡ä»¤            (~5000 tokens)         â”‚
â”‚    - å½“å‰æ¿€æ´» Skill çš„å®Œæ•´æŒ‡ä»¤                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [åŠ¨æ€] Working Memory           (å¼¹æ€§åˆ†é…)              â”‚
â”‚    - å½“å‰ä»»åŠ¡TODO                                        â”‚
â”‚    - æœ€è¿‘å¯¹è¯æ‘˜è¦                                        â”‚
â”‚    - å·¥å…·è°ƒç”¨ç»“æœ                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [åŠ¨æ€] å¯¹è¯å†å²                 (å¼¹æ€§åˆ†é…)              â”‚
â”‚    - å‹ç¼©åçš„å†å²æ¶ˆæ¯                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æœ«å°¾] Plan Recitation          (~200 tokens)          â”‚
â”‚    - å½“å‰TODOæ¸…å•                                        â”‚
â”‚    - æ ¸å¿ƒç›®æ ‡é‡ç”³                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å‹ç¼©è§¦å‘æ¡ä»¶: usage > 70%
å‹ç¼©ç­–ç•¥:
  1. å¯¹è¯å†å²æ‘˜è¦å‹ç¼©
  2. å·¥å…·è°ƒç”¨ç»“æœç²¾ç®€
  3. ä¿ç•™å¤±è´¥è®°å½•ï¼ˆKeep the Failuresï¼‰
```

## 5. éƒ¨ç½²æ¶æ„

### 5.1 å¼€å‘ç¯å¢ƒ

```yaml
# docker-compose.yml
services:
  postgres:
    image: pgvector/pgvector:pg16
    ports: ["5432:5432"]
    
  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]
    
  minio:
    image: minio/minio
    ports: ["9000:9000", "9001:9001"]
    
  api:
    build: ./packages/server
    ports: ["8000:8000"]
    depends_on: [postgres, redis, minio]
    
  web:
    build: ./packages/web
    ports: ["3000:3000"]
    
  sandbox:
    image: tokendance/sandbox:latest
    privileged: true  # Docker-in-Docker
```

### 5.2 ç”Ÿäº§ç¯å¢ƒ

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   CDN       â”‚
                    â”‚  (é™æ€èµ„æº)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚  Nginx/ALB  â”‚
                    â”‚  (è´Ÿè½½å‡è¡¡)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ API Pod â”‚      â”‚ API Pod â”‚      â”‚ API Pod â”‚
    â”‚  (x N)  â”‚      â”‚  (x N)  â”‚      â”‚  (x N)  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                 â”‚                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ Celery  â”‚      â”‚  Redis  â”‚      â”‚ PostgreSQL
    â”‚ Worker  â”‚      â”‚ Cluster â”‚      â”‚  Primary â”‚
    â”‚  (x M)  â”‚      â”‚  (HA)   â”‚      â”‚ + Replicaâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 6. å®‰å…¨è®¾è®¡

### 6.1 è®¤è¯ä¸æˆæƒ

| å±‚çº§ | æœºåˆ¶ |
|-----|------|
| ç”¨æˆ·è®¤è¯ | JWT Token |
| APIé‰´æƒ | OAuth 2.0 / API Key |
| æœåŠ¡é—´è®¤è¯ | mTLS |

### 6.2 æ•°æ®å®‰å…¨

| ç±»å‹ | æªæ–½ |
|-----|------|
| ä¼ è¾“åŠ å¯† | TLS 1.3 |
| å­˜å‚¨åŠ å¯† | AES-256 |
| API Key | åŠ å¯†å­˜å‚¨ï¼Œä¸æ˜æ–‡å±•ç¤º |
| æ•æ„Ÿä¿¡æ¯ | è¾“å‡ºè¿‡æ»¤ï¼Œä¸è¿”å›ç»™ç”¨æˆ· |

### 6.3 æ²™ç®±å®‰å…¨

| ç»´åº¦ | é™åˆ¶ |
|-----|------|
| CPU | 1 core |
| å†…å­˜ | 512MB |
| ç£ç›˜ | 1GB |
| ç½‘ç»œ | ä»…å…è®¸ç™½åå•åŸŸå |
| æ‰§è¡Œæ—¶é—´ | æœ€é•¿60ç§’ |

## 7. å¯è§‚æµ‹æ€§

### 7.1 æ—¥å¿—

```python
# ç»“æ„åŒ–æ—¥å¿—
{
    "timestamp": "2026-01-08T10:00:00Z",
    "level": "INFO",
    "service": "agent-engine",
    "trace_id": "abc123",
    "session_id": "sess_xxx",
    "event": "tool_call",
    "tool": "web_search",
    "duration_ms": 1500,
    "tokens_used": 500
}
```

### 7.2 æŒ‡æ ‡

| æŒ‡æ ‡ç±»å‹ | ç¤ºä¾‹ |
|---------|------|
| å»¶è¿Ÿ | p50/p95/p99 å“åº”æ—¶é—´ |
| åå | QPS, å¹¶å‘ä¼šè¯æ•° |
| èµ„æº | CPU/å†…å­˜/ç£ç›˜ä½¿ç”¨ç‡ |
| ä¸šåŠ¡ | Tokenæ¶ˆè€—, ä»»åŠ¡æˆåŠŸç‡, Skillä½¿ç”¨åˆ†å¸ƒ |

### 7.3 è¿½è¸ª

- æ¯ä¸ªè¯·æ±‚åˆ†é…å”¯ä¸€ trace_id
- è®°å½•å®Œæ•´çš„Agentæ€è€ƒ/æ‰§è¡Œé“¾è·¯
- æ”¯æŒæŒ‰ trace_id æŸ¥è¯¢å®Œæ•´æ—¥å¿—

## 8. æ‰©å±•æ€§è®¾è®¡

### 8.1 Skillæ‰©å±•

æ–°å¢Skillåªéœ€ï¼š
1. åœ¨ `skills/` ç›®å½•åˆ›å»ºæ–‡ä»¶å¤¹
2. ç¼–å†™ `SKILL.md` (éµå¾ªè§„èŒƒ)
3. æ·»åŠ  `resources/` èµ„æºæ–‡ä»¶
4. æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç ï¼Œçƒ­åŠ è½½ç”Ÿæ•ˆ

### 8.2 Toolæ‰©å±•

```python
# tools/custom_tool.py
from app.tools.base import BaseTool, tool_registry

@tool_registry.register
class CustomTool(BaseTool):
    name = "custom_tool"
    description = "Custom tool description"
    
    async def execute(self, **params) -> ToolResult:
        # å®ç°é€»è¾‘
        pass
```

### 8.3 LLM Provideræ‰©å±•

```python
# core/llm/custom_provider.py
from app.core.llm.base import BaseLLMProvider

class CustomProvider(BaseLLMProvider):
    async def chat(self, messages, **kwargs):
        # å®ç°é€»è¾‘
        pass
```

## 9. é™„å½•

### A. ç›¸å…³æ–‡æ¡£

- [PRDæ–‡æ¡£](../product/PRD.md)
- [UIè®¾è®¡æ–‡æ¡£](../design/UI-Design.md)
- [æŠ€æœ¯LLD](./LLD.md)
- [Skillä¸“é¡¹è®¾è®¡](../modules/Skill-Design.md)
- [Memoryä¸“é¡¹è®¾è®¡](../modules/Memory-Design.md)
- [Sandboxä¸“é¡¹è®¾è®¡](../modules/Sandbox-Design.md)

### B. å‚è€ƒèµ„æ–™

- Manus Architecture Insights
- GenSpark Technical Blog
- Claude API Documentation
- FastAPI Best Practices
