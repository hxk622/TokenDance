# TokenDance æŠ€æœ¯æ¶æ„è®¾è®¡ - é«˜å±‚è®¾è®¡ (HLD)

> Version: 1.2.0 | MVPé˜¶æ®µ
> Last Updated: 2026-01-12

## 1. æ¶æ„æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

TokenDanceæ˜¯ä¸€ä¸ªé€šç”¨AI Agentå¹³å°ï¼ŒæŠ€æœ¯æ¶æ„éœ€è¦æ»¡è¶³ä»¥ä¸‹æ ¸å¿ƒç›®æ ‡ï¼š

| ç›®æ ‡ | æè¿° | å…³é”®æŒ‡æ ‡ |
|-----|------|---------|
| **Tokenæ•ˆç‡** | æœ€å¤§åŒ–åˆ©ç”¨context windowï¼Œæœ€å°åŒ–tokenæ¶ˆè€— | å•ä»»åŠ¡tokenæ¶ˆè€—é™ä½50%+ |
| **å“åº”é€Ÿåº¦** | åˆ©ç”¨KV Cacheå®ç°å¿«é€Ÿå“åº” | é¦–å­—å»¶è¿Ÿ < 500ms |
| **å¯æ‰©å±•æ€§** | Skillå¯æ’æ‹”ï¼Œå·¥å…·å¯æ‰©å±• | æ–°å¢Skillæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç  |
| **å¯é æ€§** | ä»»åŠ¡å¯æ¢å¤ï¼Œç»“æœå¯éªŒè¯ | ä»»åŠ¡æˆåŠŸç‡ > 95% |
| **å®‰å…¨æ€§** | ä»£ç æ‰§è¡Œéš”ç¦»ï¼Œæ•°æ®ç§Ÿæˆ·éš”ç¦» | é›¶å®‰å…¨äº‹æ•… |

### 1.2 æ ¸å¿ƒæ¶æ„åŸåˆ™

åŸºäºManusã€GenSparkç­‰äº§å“çš„æœ€ä½³å®è·µï¼Œæˆ‘ä»¬éµå¾ªä»¥ä¸‹æ¶æ„åŸåˆ™ï¼š

#### 1.2.0 å¤šç§Ÿæˆ·éš”ç¦»ï¼ˆMulti-Tenancy Isolationï¼‰ğŸ†• â­
- **ä¸‰å±‚ç§Ÿæˆ·æ¨¡å‹**ï¼šOrganization â†’ Team â†’ Workspace
- **ç‰©ç†éš”ç¦»**ï¼šFileSystem æŒ‰ Org/Team/Workspace åˆ†å±‚ç›®å½•
- **é€»è¾‘éš”ç¦»**ï¼šPostgreSQL RLS + Redis å‘½åç©ºé—´
- **KV-Cache éš”ç¦»**ï¼šæ¯ä¸ª Org ç‹¬ç«‹ Global Prefixï¼ŒTeam å…±äº« Skill Cache
- **èµ„æºé…é¢**ï¼šæŒ‰ Organization åˆ†é…å’Œè¿½è¸ªèµ„æºä½¿ç”¨é‡
- å‚è€ƒï¼š[Multi-Tenancy è®¾è®¡](./Multi-Tenancy.md)

#### 1.2.1 Plan Recitationï¼ˆç›®æ ‡èƒŒè¯µï¼‰
- æ¯æ¬¡Agentå¾ªç¯å°†å½“å‰TODOæ¸…å•è¿½åŠ åˆ°contextæœ«å°¾
- é˜²æ­¢é•¿ä»»åŠ¡ä¸­çš„"Lost-in-the-Middle"é—®é¢˜
- ç¡®ä¿Agentå§‹ç»ˆèšç„¦æ ¸å¿ƒç›®æ ‡

#### 1.2.2 Keep the Failuresï¼ˆä¿ç•™é”™è·¯ï¼‰
- å¤±è´¥çš„å°è¯•å’Œå †æ ˆè¿½è¸ªä¿ç•™åœ¨contextä¸­
- è®©Agentå½¢æˆ"å…ˆéªŒé¿å‘"èƒ½åŠ›
- ä»é”™è¯¯ä¸­å­¦ä¹ æ˜¯æ™ºèƒ½çš„æ ¸å¿ƒæ ‡å¿—

#### 1.2.3 KV Caching Stabilityï¼ˆå‰ç¼€ç¨³å®šï¼‰â­
- System Promptä¿æŒå›ºå®šä¸å˜
- æ‰€æœ‰å·¥å…·å®šä¹‰åœ¨åˆå§‹åŒ–æ—¶ä¸€æ¬¡æ€§åŠ è½½
- ä¸åœ¨å¼€å¤´æ’å…¥æ—¶é—´æˆ³/åŠ¨æ€ID
- ç›®æ ‡ï¼šKV-Cache å‘½ä¸­ç‡ > 90%

#### 1.2.4 Append-Only Context Growthï¼ˆçº¯è¿½åŠ ä¸Šä¸‹æ–‡ï¼‰ğŸ†• â­
- Context åªè¿½åŠ ï¼Œæ°¸ä¸ä¿®æ”¹å·²æœ‰å†…å®¹
- æ¯è½®å¯¹è¯è¿½åŠ æ–°å†…å®¹ï¼šæ€è€ƒ + å·¥å…·è°ƒç”¨ + ç»“æœ
- ä¿è¯ KV-Cache æŒç»­æœ‰æ•ˆï¼Œé¿å…é‡å¤è®¡ç®—
- æ€§èƒ½æå‡ï¼š7x fasterï¼ˆç›¸æ¯”æ¯è½®é‡æ„ contextï¼‰

#### 1.2.5 Structured Tagsï¼ˆç»“æ„åŒ–æ ‡è®°ï¼‰ğŸ†•
- ä½¿ç”¨æ˜ç¡®çš„æ ‡è®°åŒºåˆ†ä¸åŒç±»å‹çš„å†…å®¹
- æ ‡è®°ç³»ç»Ÿï¼šSYSTEM, TOOLS, USER, REASONING, TOOL_CALL, TOOL_RESULT, FINAL_ANSWER
- ä¾¿äºæ¨¡å‹ç†è§£è¯­ä¹‰è¾¹ç•Œ
- ä¾¿äºç³»ç»Ÿè§£æå’Œç¼“å­˜ç®¡ç†

#### 1.2.6 Tool Definition Maskingï¼ˆå·¥å…·å®šä¹‰æ©ç ï¼‰ğŸ†•
- æ‰€æœ‰å·¥å…·å®šä¹‰åœ¨åˆå§‹åŒ–æ—¶åŠ è½½ï¼ˆå›ºå®šå‰ç¼€çš„ä¸€éƒ¨åˆ†ï¼‰
- é€šè¿‡ Attention Mask æ§åˆ¶æŸäº›å·¥å…·çš„å¯è§æ€§
- å·¥å…·å®šä¹‰æ°¸è¿œåœ¨ context ä¸­ï¼ŒKV-Cache 100% å‘½ä¸­
- é€šè¿‡æ©ç æŠ€æœ¯è®©æ¨¡å‹"çœ‹ä¸è§"ä¸å¯ç”¨çš„å·¥å…·

#### 1.2.7 Controlled Randomnessï¼ˆå—æ§éšæœºï¼‰
- æ£€æµ‹åˆ°é‡å¤åŠ¨ä½œæ—¶å¼•å…¥ç»“æ„åŒ–å˜åŒ–
- æ‰“ç ´æ³¨æ„åŠ›å›ºå®šæ¨¡å¼
- é¿å…æ­»å¾ªç¯

#### 1.2.8 Dual Context Streamsï¼ˆåŒé‡åˆ†èº«ï¼‰
- Working Memoryï¼šç²¾ç®€æ‘˜è¦ç»™LLMå†³ç­–
- File Systemï¼šå…¨é‡åŸå§‹æ•°æ®æŒä¹…åŒ–
- ç±»ä¼¼äººç±»çš„çŸ­æœŸ/é•¿æœŸè®°å¿†åˆ†ç¦»

#### 1.2.9 Action Space Pruningï¼ˆå·¥å…·ç²¾ç®€ï¼‰
- æä¾›å°‘æ•°é«˜æ³›åŒ–å·¥å…·ï¼Œè€Œéå¤§é‡å‚ç›´API
- Agentå¯åœ¨æ²™ç®±ä¸­æ ¹æ®éœ€æ±‚è‡ªå»ºå·¥å…·
- å‡å°‘æ¨¡å‹çš„é€‰æ‹©å›°éš¾

#### 1.2.10 3-File Working Memory Patternï¼ˆä¸‰æ–‡ä»¶å·¥ä½œæ³•ï¼‰ğŸ†• â­â­â­
**æ¥æº**ï¼šManus Agent æ ¸å¿ƒæ¶æ„åŸåˆ™ï¼Œå·²è¢«éªŒè¯æœ‰æ•ˆ

**æ ¸å¿ƒç†å¿µ**ï¼šåˆ©ç”¨æŒä¹…åŒ– Markdown æ–‡ä»¶ä½œä¸º Agent çš„"å·¥ä½œè®°å¿†"ï¼Œè€Œä¸æ˜¯å®Œå…¨ä¾èµ–è„†å¼±ä¸”æ˜‚è´µçš„ Context Window

**ä¸‰ä¸ªæ ¸å¿ƒæ–‡ä»¶**ï¼š
1. **task_plan.mdï¼ˆè·¯çº¿å›¾ï¼‰**
   - ä½œç”¨ï¼šä»»åŠ¡æ‹†è§£ï¼ŒAI å¿…é¡»å…ˆå†™å¥½ Phase 1, Phase 2... çš„è®¡åˆ’
   - å…³é”®æœºåˆ¶ï¼šSessionStart å’Œ PreToolUse é’©å­å¼ºåˆ¶ AI "é‡è¯»"è®¡åˆ’
   - é˜²æ­¢ï¼šContext Driftï¼ˆä¸Šä¸‹æ–‡æ¼‚ç§»ï¼‰

2. **findings.mdï¼ˆçŸ¥è¯†åº“ï¼‰**
   - ä½œç”¨ï¼šå­˜å‚¨ç ”ç©¶å‘ç°å’ŒæŠ€æœ¯å†³ç­–
   - å…³é”®æœºåˆ¶ï¼š**2-Action Rule** - æ¯è¿›è¡Œä¸¤æ¬¡æœç´¢/æµè§ˆæ“ä½œï¼ŒAI å¿…é¡»å°†å‘ç°å­˜å…¥æ­¤æ–‡ä»¶
   - æ”¶ç›Šï¼šæå¤§èŠ‚çœ Tokenï¼Œé¿å…ä¸Šä¸‹æ–‡çˆ†ç‚¸

3. **progress.mdï¼ˆæ‰§è¡Œæ—¥å¿—ï¼‰**
   - ä½œç”¨ï¼šè®°å½•æ‰§è¡Œè¿‡ç¨‹å’Œæµ‹è¯•ç»“æœ
   - å…³é”®æœºåˆ¶ï¼š**å¼ºåˆ¶è®°å½•æ‰€æœ‰é”™è¯¯**
   - æ”¶ç›Šï¼šé˜²æ­¢ AI åœ¨åŒä¸€ä¸ªå‘é‡Œåå¤æ‘”å€’ï¼ˆä¸é‡å¤å¤±è´¥åŸåˆ™ï¼‰

**é…å¥—è¡Œä¸ºè§„åˆ™**ï¼š
- **2-Action Ruleï¼ˆ2æ¬¡è¡ŒåŠ¨è§„åˆ™ï¼‰**ï¼šæ“ä½œä¸¤æ¬¡å¿…è®°å½•ï¼Œé˜²æ­¢ä¸Šä¸‹æ–‡çˆ†ç‚¸
- **3-Strike Protocolï¼ˆ3æ¬¡æ‰“å‡»åè®®ï¼‰**ï¼šåŒç±»é”™è¯¯å‡ºç°3æ¬¡ï¼Œå¿…é¡»åœä¸‹æ¥é‡è¯»è®¡åˆ’å¹¶é‡æ–°å®¡è§†æ–¹æ³•è®º
- **5-Question Reboot Testï¼ˆ5é—®é‡å¯æµ‹è¯•ï¼‰**ï¼šAgent è¿·èŒ«æ—¶é€šè¿‡5ä¸ªé—®é¢˜è‡ªæˆ‘æ£€æµ‹ï¼Œé‡æ–°æ‰¾å›ç›®æ ‡

**æŠ€æœ¯ä¼˜åŠ¿**ï¼š
- Token æ¶ˆè€—é™ä½ 60-80%ï¼ˆç›¸æ¯”å…¨éƒ¨å¡å…¥ Contextï¼‰
- é•¿ä»»åŠ¡æˆåŠŸç‡æå‡ 40%+ï¼ˆManus å®æµ‹æ•°æ®ï¼‰
- å®Œç¾æ”¯æŒè·¨ Session æ¢å¤ï¼ˆæ–‡ä»¶æŒä¹…åŒ–ï¼‰
- ä¸ Plan Recitationã€Keep the Failures åŸåˆ™æ— ç¼é…åˆ

**å®æ–½è¦ç‚¹**ï¼š
- ä¸‰ä¸ªæ–‡ä»¶å­˜å‚¨åœ¨ Workspace FileSystem ä¸­
- æ¯ä¸ª Session ç‹¬ç«‹ç›®å½•ï¼š`/workspace/{org_id}/{team_id}/{workspace_id}/{session_id}/`
- Agent åœ¨å…³é”®å†³ç­–ç‚¹ï¼ˆå·¥å…·è°ƒç”¨å‰ã€é”™è¯¯å‘ç”Ÿåï¼‰å¿…é¡»è¯»å–/æ›´æ–°æ–‡ä»¶
- å‰ç«¯ UI éœ€è¦å±•ç¤º"Working Memory"æ ‡ç­¾é¡µï¼Œå®æ—¶æ˜¾ç¤ºä¸‰æ–‡ä»¶å†…å®¹

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Client Layer                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    Vue3 + Tailwind + Shadcn/UI                   â”‚    â”‚
â”‚  â”‚    [Chat UI]  [Workspace]  [PPT Preview]  [Research Report]      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ WebSocket / REST / SSE
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             API Gateway                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         FastAPI                                  â”‚    â”‚
â”‚  â”‚   [Auth] [Rate Limit] [Router] [WebSocket Manager] [SSE Stream]  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent Engine â”‚    â”‚    Celery     â”‚    â”‚  File Service â”‚
â”‚     Core      â”‚    â”‚  Task Queue   â”‚    â”‚    (MinIO)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                      â”‚
        â–¼                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Skill System         â”‚    â”‚      Tool System          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Skill Registry    â”‚  â”‚    â”‚  â”‚    web_search       â”‚  â”‚
â”‚  â”‚   Skill Matcher     â”‚  â”‚    â”‚  â”‚    read_url         â”‚  â”‚
â”‚  â”‚   Skill Loader      â”‚  â”‚    â”‚  â”‚    code_execute     â”‚  â”‚
â”‚  â”‚   (L1/L2/L3)        â”‚  â”‚    â”‚  â”‚    file_ops         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â”‚    create_artifact  â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                      â”‚
        â–¼                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Context Manager        â”‚    â”‚     Sandbox Manager       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Token Budget       â”‚  â”‚    â”‚  â”‚  Docker Container   â”‚  â”‚
â”‚  â”‚  Auto Compression   â”‚  â”‚    â”‚  â”‚  Resource Limit     â”‚  â”‚
â”‚  â”‚  KV Cache Optimize  â”‚  â”‚    â”‚  â”‚  Network Isolation  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                      â”‚
        â–¼                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Memory System         â”‚    â”‚      Validator            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Working Memory     â”‚  â”‚    â”‚  â”‚  Result Verifier    â”‚  â”‚
â”‚  â”‚  Episode Memory     â”‚  â”‚    â”‚  â”‚  (B Model)          â”‚  â”‚
â”‚  â”‚  Long-term Memory   â”‚  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Infrastructure Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ PostgreSQL  â”‚  â”‚   Redis     â”‚  â”‚   MinIO     â”‚  â”‚   Docker    â”‚     â”‚
â”‚  â”‚ + pgvector  â”‚  â”‚  Cache/MQ   â”‚  â”‚   Storage   â”‚  â”‚   Sandbox   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           External Services                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Claude API  â”‚  â”‚ Gemini API  â”‚  â”‚ Tavily API  â”‚                      â”‚
â”‚  â”‚  (ä¸»æ¨¡å‹)    â”‚  â”‚  (å¤‡é€‰)     â”‚  â”‚  (æœç´¢)     â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¨¡å—èŒè´£

| æ¨¡å— | èŒè´£ | å…³é”®æ¥å£ |
|-----|------|---------|
| **API Gateway** | è·¯ç”±ã€è®¤è¯ã€é™æµã€WebSocketç®¡ç†ã€å¤šç§Ÿæˆ·é‰´æƒ | REST API, WebSocket |
| **Tenant Manager** | ğŸ†• ç»„ç»‡/å›¢é˜Ÿ/å·¥ä½œåŒºç®¡ç†ã€æƒé™æ£€æŸ¥ã€é…é¢æ§åˆ¶ | check_permission(), check_quota() |
| **Agent Engine** | æ ¸å¿ƒå†³ç­–å¾ªç¯ã€å·¥å…·è°ƒç”¨ç¼–æ’ | run(), step() |
| **Skill System** | ä¸‰çº§æ‡’åŠ è½½ã€SkillåŒ¹é…ä¸æ‰§è¡Œ | match(), load(), execute() |
| **Tool System** | å·¥å…·æ³¨å†Œä¸æ‰§è¡Œ | register(), invoke() |
| **Context Manager** | Tokené¢„ç®—ç®¡ç†ã€è‡ªåŠ¨å‹ç¼©ã€æ–‡ä»¶ç³»ç»ŸæŒ‡é’ˆ | allocate(), compress() |
| **Memory System** | ä¸‰å±‚è®°å¿†ç®¡ç†ï¼ˆæ•°æ®åº“ + æ–‡ä»¶ç³»ç»Ÿï¼‰ | store(), retrieve(), summarize() |
| **Sandbox Manager** | å®¹å™¨ç”Ÿå‘½å‘¨æœŸã€ä»£ç æ‰§è¡Œ | create(), execute(), destroy() |
| **Validator** | ç»“æœéªŒè¯ã€å¹»è§‰æ£€æµ‹ | verify() |

## 3. æŠ€æœ¯é€‰å‹

### 3.1 æŠ€æœ¯æ ˆæ€»è§ˆ

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|-----|---------|-----|
| **å‰ç«¯** | Vue 3 + TypeScript | å“åº”å¼æ¡†æ¶ |
| **UIç»„ä»¶** | Shadcn/UI Vue + Tailwind | ç°ä»£UIç»„ä»¶åº“ |
| **çŠ¶æ€ç®¡ç†** | Pinia | Vueå®˜æ–¹æ¨è |
| **åç«¯æ¡†æ¶** | FastAPI | é«˜æ€§èƒ½å¼‚æ­¥æ¡†æ¶ |
| **ä»»åŠ¡é˜Ÿåˆ—** | Celery + Redis | å¼‚æ­¥ä»»åŠ¡å¤„ç† |
| **ä¸»æ•°æ®åº“** | PostgreSQL + pgvector + RLS | å…³ç³»æ•°æ® + å‘é‡å­˜å‚¨ + è¡Œçº§å®‰å…¨ ğŸ†• |
| **KV-Cache** | Redis | KV-Cache æŒä¹…åŒ–ï¼ˆæ”¯æŒ RDB/AOFï¼‰ğŸ†• |
| **å‘é‡æ•°æ®åº“** | Milvus | Skill åŒ¹é…ã€æ€ç»´å¿«ç…§æ£€ç´¢ ğŸ†• |
| **å¯¹è±¡å­˜å‚¨** | MinIO | æ–‡ä»¶ã€äº§å‡ºç‰©å­˜å‚¨ |
| **æ²™ç®±** | Docker | ä»£ç æ‰§è¡Œéš”ç¦» |
| **LLM** | Claude API / Gemini API | ä¸»æ¨ç†å¼•æ“ |
| **æœç´¢** | Tavily API | Webæœç´¢æœåŠ¡ |

### 3.2 å…³é”®æŠ€æœ¯å†³ç­–

#### ä¸ºä»€ä¹ˆé€‰æ‹© FastAPIï¼Ÿ
- åŸç”Ÿå¼‚æ­¥æ”¯æŒï¼Œé€‚åˆI/Oå¯†é›†å‹Agentåœºæ™¯
- è‡ªåŠ¨OpenAPIæ–‡æ¡£ç”Ÿæˆ
- ç±»å‹æç¤ºå‹å¥½ï¼Œä»£ç å¯ç»´æŠ¤æ€§é«˜
- WebSocketåŸç”Ÿæ”¯æŒ

#### ä¸ºä»€ä¹ˆé€‰æ‹© PostgreSQL + pgvectorï¼Ÿ
- äº‹åŠ¡æ”¯æŒï¼Œæ•°æ®ä¸€è‡´æ€§ä¿è¯
- pgvectoræ‰©å±•æä¾›å‘é‡å­˜å‚¨ï¼Œæ— éœ€é¢å¤–å‘é‡æ•°æ®åº“
- å•ä¸€æ•°æ®åº“ç®€åŒ–è¿ç»´

#### ä¸ºä»€ä¹ˆé€‰æ‹© Dockerä½œä¸ºæ²™ç®±ï¼Ÿ
- æˆç†Ÿç¨³å®šï¼Œç”Ÿæ€å®Œå–„
- èµ„æºéš”ç¦»å’Œé™åˆ¶èƒ½åŠ›å¼º
- å¿«é€Ÿå¯åŠ¨ï¼ˆç›¸æ¯”VMï¼‰
- å¯æ‰©å±•è‡³Kubernetes

## 4. å¤šç§Ÿæˆ·æ¶æ„

### 4.1 ä¸‰å±‚ç§Ÿæˆ·æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç§Ÿæˆ·å±‚çº§ï¼šOrganization â†’ Team â†’ Workspace              â”‚
â”‚                                                            â”‚
â”‚  Organization (ç»„ç»‡/ä¼ä¸š)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ è®¡è´¹å•å…ƒï¼šç»Ÿä¸€è®¡è´¹                                â”‚  â”‚
â”‚  â”‚ â€¢ èµ„æºé…é¢ï¼šmax_teams, max_workspaces, max_agents  â”‚  â”‚
â”‚  â”‚ â€¢ æ•°æ®éš”ç¦»ï¼šç‰©ç† + é€»è¾‘åŒé‡éš”ç¦»                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                                               â”‚
â”‚            â””â”€â”€â”€â”€â”€ Team (å›¢é˜Ÿ)                        â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                  â”‚ â€¢ åä½œå•å…ƒ                    â”‚  â”‚
â”‚                  â”‚ â€¢ å…±äº«èµ„æºï¼šçŸ¥è¯†åº“ã€æ¨¡æ¿    â”‚  â”‚
â”‚                  â”‚ â€¢ Team Skill Cache å…±äº«    â”‚  â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â”‚                             â”‚
â”‚                        â””â”€â”€â”€ Workspace (å·¥ä½œåŒº)   â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                            â”‚ â€¢ ç‹¬ç«‹å·¥ä½œç©ºé—´  â”‚  â”‚
â”‚                            â”‚ â€¢ Agents      â”‚  â”‚
â”‚                            â”‚ â€¢ Tasks       â”‚  â”‚
â”‚                            â”‚ â€¢ Files       â”‚  â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ•°æ®éš”ç¦»ç­–ç•¥

**ç‰©ç†éš”ç¦»ï¼ˆFileSystemï¼‰**ï¼š
```bash
/data/orgs/
â””â”€â”€ org-{org_id}/                    # Organization çº§åˆ«éš”ç¦»
    â”œâ”€â”€ .metadata
    â”œâ”€â”€ billing/
    â””â”€â”€ teams/
        â””â”€â”€ team-{team_id}/          # Team çº§åˆ«éš”ç¦»
            â”œâ”€â”€ shared/               # å›¢é˜Ÿå…±äº«èµ„æº
            â”‚   â”œâ”€â”€ knowledge_base/
            â”‚   â””â”€â”€ templates/
            â””â”€â”€ workspaces/
                â””â”€â”€ ws-{workspace_id}/  # Workspace çº§åˆ«éš”ç¦»
                    â”œâ”€â”€ tasks/
                    â”œâ”€â”€ context/
                    â”œâ”€â”€ cache/
                    â””â”€â”€ drafts/
```

**é€»è¾‘éš”ç¦»ï¼ˆDatabase + Redisï¼‰**ï¼š
- PostgreSQL RLSï¼šè¡Œçº§å®‰å…¨ç­–ç•¥
- Redis å‘½åç©ºé—´ï¼š`kv_cache:org:{org_id}:ws:{workspace_id}:session:{session_id}`

### 4.3 æƒé™çŸ©é˜µ

| èµ„æº | Owner | Admin | Member | Guest |
|------|-------|-------|--------| -------|
| **Organization** |
| æŸ¥çœ‹ | âœ… | âœ… | âœ… | âœ… |
| ä¿®æ”¹ | âœ… | âœ… | âŒ | âŒ |
| åˆ é™¤ | âœ… | âŒ | âŒ | âŒ |
| **Workspace** |
| åˆ›å»º | âœ… | âœ… | âœ… | âŒ |
| ç¼–è¾‘ | Owner/Editor | Owner/Editor | Owner/Editor | âŒ |
| æ‰§è¡Œä»»åŠ¡ | Owner/Editor | Owner/Editor | Owner/Editor | âŒ |
| æŸ¥çœ‹ | âœ… | âœ… | æŒ‰å¯è§æ€§ | Viewer |

è¯¦ç»†è®¾è®¡å‚è€ƒï¼š[Multi-Tenancy.md](./Multi-Tenancy.md)

---

## 5. æ•°æ®æµè®¾è®¡

### 5.1 ç”¨æˆ·è¯·æ±‚å¤„ç†æµç¨‹ï¼ˆå¤šç§Ÿæˆ·ï¼‰

```
ç”¨æˆ·è¾“å…¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Gateway          â”‚
â”‚  - JWT é‰´æƒ            â”‚
â”‚  - æå– org_id/team_id â”‚ ğŸ†•
â”‚  - å‚æ•°æ ¡éªŒ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tenant Manager       â”‚ ğŸ†•
â”‚  - æƒé™æ£€æŸ¥           â”‚
â”‚  - é…é¢æ£€æŸ¥           â”‚
â”‚  - èµ„æºéš”ç¦»           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Session Manager      â”‚
â”‚  - åŠ è½½ Workspace å†å² â”‚
â”‚  - åˆ›å»ºä¼šè¯           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Skill Router   â”‚â—„â”€â”€â”€ L1 å…ƒæ•°æ®åŒ¹é…
â”‚  - æ„å›¾è¯†åˆ«     â”‚
â”‚  - Skillé€‰æ‹©    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Skill Loader   â”‚â—„â”€â”€â”€ æŒ‰éœ€åŠ è½½ L2/L3
â”‚  - åŠ è½½æŒ‡ä»¤     â”‚
â”‚  - æ³¨å…¥Context  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Agent Loop                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         while not done:          â”‚    â”‚
â”‚  â”‚  1. Context Manager ç»„è£…prompt   â”‚    â”‚
â”‚  â”‚  2. LLM æ¨ç†                     â”‚    â”‚
â”‚  â”‚  3. è§£æTool Call               â”‚    â”‚
â”‚  â”‚  4. Tool Executor æ‰§è¡Œ          â”‚    â”‚
â”‚  â”‚  5. Validator éªŒè¯ç»“æœ          â”‚    â”‚
â”‚  â”‚  6. Memory æ›´æ–°                 â”‚    â”‚
â”‚  â”‚  7. Plan Recitation èƒŒè¯µç›®æ ‡    â”‚    â”‚
â”‚  â”‚  8. æµå¼è¾“å‡ºç»™å‰ç«¯              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response       â”‚
â”‚  - SSEæµå¼æ¨é€  â”‚
â”‚  - äº§å‡ºç‰©å­˜å‚¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 SkillåŠ è½½æµç¨‹

```
å¯åŠ¨æ—¶:
  æ‰«æ skills/ ç›®å½•
       â”‚
       â–¼
  è§£ææ‰€æœ‰ SKILL.md çš„ YAML å¤´
       â”‚
       â–¼
  æ„å»º L1 å…ƒæ•°æ®ç´¢å¼• (å†…å­˜)
       â”‚
       â–¼
  æ³¨å…¥ System Prompt (çº¦100 tokens/skill)

è¿è¡Œæ—¶:
  ç”¨æˆ·æ¶ˆæ¯åˆ°è¾¾
       â”‚
       â–¼
  SkillMatcher.match(message)
       â”‚
       â”œâ”€â”€â”€ æ— åŒ¹é… â”€â”€â”€ ä½¿ç”¨é»˜è®¤å¯¹è¯èƒ½åŠ›
       â”‚
       â””â”€â”€â”€ åŒ¹é…åˆ° Skill
              â”‚
              â–¼
       SkillLoader.load_l2(skill_id)
              â”‚
              â–¼
       æ³¨å…¥ L2 æŒ‡ä»¤åˆ° Context (~5000 tokens)
              â”‚
              â–¼
       Agent æ‰§è¡Œè¿‡ç¨‹ä¸­æŒ‰éœ€è¯·æ±‚ L3 èµ„æº
              â”‚
              â”œâ”€â”€â”€ éœ€è¦å­æŠ€èƒ½ â”€â”€â”€ è¯»å– Sub-SKILL.md
              â”‚
              â”œâ”€â”€â”€ éœ€è¦æ‰§è¡Œè„šæœ¬ â”€â”€â”€ æ²™ç®±æ‰§è¡Œï¼Œè¿”å›è¾“å‡º
              â”‚
              â””â”€â”€â”€ éœ€è¦å‚è€ƒæ–‡æ¡£ â”€â”€â”€ è¯»å– Reference
```

### 4.3 Contextç»„è£…æµç¨‹

```
Token Budget: 128K (Claude) / 1M (Gemini)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Context Window                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [å›ºå®š] System Prompt           (~2000 tokens)          â”‚
â”‚    - è§’è‰²å®šä¹‰                                            â”‚
â”‚    - è¡Œä¸ºå‡†åˆ™                                            â”‚
â”‚    - è¾“å‡ºæ ¼å¼                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [å›ºå®š] L1 Skill å…ƒæ•°æ®          (~100 * N tokens)      â”‚
â”‚    - æ‰€æœ‰å·²å®‰è£… Skill çš„ name + description             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [åŠ¨æ€] L2 Skill æŒ‡ä»¤            (~5000 tokens)         â”‚
â”‚    - å½“å‰æ¿€æ´» Skill çš„å®Œæ•´æŒ‡ä»¤                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [åŠ¨æ€] Working Memory           (å¼¹æ€§åˆ†é…)              â”‚
â”‚    - å½“å‰ä»»åŠ¡TODO                                        â”‚
â”‚    - æœ€è¿‘å¯¹è¯æ‘˜è¦                                        â”‚
â”‚    - å·¥å…·è°ƒç”¨ç»“æœ                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [åŠ¨æ€] å¯¹è¯å†å²                 (å¼¹æ€§åˆ†é…)              â”‚
â”‚    - å‹ç¼©åçš„å†å²æ¶ˆæ¯                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æœ«å°¾] Plan Recitation          (~200 tokens)          â”‚
â”‚    - å½“å‰TODOæ¸…å•                                        â”‚
â”‚    - æ ¸å¿ƒç›®æ ‡é‡ç”³                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å‹ç¼©è§¦å‘æ¡ä»¶: usage > 70%
å‹ç¼©ç­–ç•¥:
  1. å¯¹è¯å†å²æ‘˜è¦å‹ç¼©
  2. å·¥å…·è°ƒç”¨ç»“æœç²¾ç®€
  3. ä¿ç•™å¤±è´¥è®°å½•ï¼ˆKeep the Failuresï¼‰
```

## 5. éƒ¨ç½²æ¶æ„

### 5.1 å¼€å‘ç¯å¢ƒ

```yaml
# docker-compose.yml
services:
  postgres:
    image: pgvector/pgvector:pg16
    ports: ["5432:5432"]
    
  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]
    
  minio:
    image: minio/minio
    ports: ["9000:9000", "9001:9001"]
    
  api:
    build: ./packages/server
    ports: ["8000:8000"]
    depends_on: [postgres, redis, minio]
    
  web:
    build: ./packages/web
    ports: ["3000:3000"]
    
  sandbox:
    image: tokendance/sandbox:latest
    privileged: true  # Docker-in-Docker
```

### 5.2 ç”Ÿäº§ç¯å¢ƒ

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   CDN       â”‚
                    â”‚  (é™æ€èµ„æº)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚  Nginx/ALB  â”‚
                    â”‚  (è´Ÿè½½å‡è¡¡)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ API Pod â”‚      â”‚ API Pod â”‚      â”‚ API Pod â”‚
    â”‚  (x N)  â”‚      â”‚  (x N)  â”‚      â”‚  (x N)  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                 â”‚                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ Celery  â”‚      â”‚  Redis  â”‚      â”‚ PostgreSQL
    â”‚ Worker  â”‚      â”‚ Cluster â”‚      â”‚  Primary â”‚
    â”‚  (x M)  â”‚      â”‚  (HA)   â”‚      â”‚ + Replicaâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 6. å®‰å…¨è®¾è®¡

### 6.1 è®¤è¯ä¸æˆæƒ

| å±‚çº§ | æœºåˆ¶ |
|-----|------|
| ç”¨æˆ·è®¤è¯ | JWT Token |
| APIé‰´æƒ | OAuth 2.0 / API Key |
| æœåŠ¡é—´è®¤è¯ | mTLS |

### 6.2 æ•°æ®å®‰å…¨

| ç±»å‹ | æªæ–½ |
|-----|------|
| ä¼ è¾“åŠ å¯† | TLS 1.3 |
| å­˜å‚¨åŠ å¯† | AES-256 |
| API Key | åŠ å¯†å­˜å‚¨ï¼Œä¸æ˜æ–‡å±•ç¤º |
| æ•æ„Ÿä¿¡æ¯ | è¾“å‡ºè¿‡æ»¤ï¼Œä¸è¿”å›ç»™ç”¨æˆ· |

### 6.3 æ²™ç®±å®‰å…¨

| ç»´åº¦ | é™åˆ¶ |
|-----|------|
| CPU | 1 core |
| å†…å­˜ | 512MB |
| ç£ç›˜ | 1GB |
| ç½‘ç»œ | ä»…å…è®¸ç™½åå•åŸŸå |
| æ‰§è¡Œæ—¶é—´ | æœ€é•¿60ç§’ |

## 7. å¯è§‚æµ‹æ€§

### 7.1 æ—¥å¿—

```python
# ç»“æ„åŒ–æ—¥å¿—
{
    "timestamp": "2026-01-08T10:00:00Z",
    "level": "INFO",
    "service": "agent-engine",
    "trace_id": "abc123",
    "session_id": "sess_xxx",
    "event": "tool_call",
    "tool": "web_search",
    "duration_ms": 1500,
    "tokens_used": 500
}
```

### 7.2 æŒ‡æ ‡

| æŒ‡æ ‡ç±»å‹ | ç¤ºä¾‹ |
|---------|------|
| å»¶è¿Ÿ | p50/p95/p99 å“åº”æ—¶é—´ |
| åå | QPS, å¹¶å‘ä¼šè¯æ•° |
| èµ„æº | CPU/å†…å­˜/ç£ç›˜ä½¿ç”¨ç‡ |
| ä¸šåŠ¡ | Tokenæ¶ˆè€—, ä»»åŠ¡æˆåŠŸç‡, Skillä½¿ç”¨åˆ†å¸ƒ |

### 7.3 è¿½è¸ª

- æ¯ä¸ªè¯·æ±‚åˆ†é…å”¯ä¸€ trace_id
- è®°å½•å®Œæ•´çš„Agentæ€è€ƒ/æ‰§è¡Œé“¾è·¯
- æ”¯æŒæŒ‰ trace_id æŸ¥è¯¢å®Œæ•´æ—¥å¿—

## 8. æ‰©å±•æ€§è®¾è®¡

### 8.1 Skillæ‰©å±•

æ–°å¢Skillåªéœ€ï¼š
1. åœ¨ `skills/` ç›®å½•åˆ›å»ºæ–‡ä»¶å¤¹
2. ç¼–å†™ `SKILL.md` (éµå¾ªè§„èŒƒ)
3. æ·»åŠ  `resources/` èµ„æºæ–‡ä»¶
4. æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç ï¼Œçƒ­åŠ è½½ç”Ÿæ•ˆ

### 8.2 Toolæ‰©å±•

```python
# tools/custom_tool.py
from app.tools.base import BaseTool, tool_registry

@tool_registry.register
class CustomTool(BaseTool):
    name = "custom_tool"
    description = "Custom tool description"
    
    async def execute(self, **params) -> ToolResult:
        # å®ç°é€»è¾‘
        pass
```

### 8.3 LLM Provideræ‰©å±•

```python
# core/llm/custom_provider.py
from app.core.llm.base import BaseLLMProvider

class CustomProvider(BaseLLMProvider):
    async def chat(self, messages, **kwargs):
        # å®ç°é€»è¾‘
        pass
```

## 9. é™„å½•

### A. ç›¸å…³æ–‡æ¡£

- [PRDæ–‡æ¡£](../product/PRD.md)
- [UIè®¾è®¡æ–‡æ¡£](../design/UI-Design.md)
- [æŠ€æœ¯LLD](./LLD.md)
- [Skillä¸“é¡¹è®¾è®¡](../modules/Skill-Design.md)
- [Memoryä¸“é¡¹è®¾è®¡](../modules/Memory-Design.md)
- [Sandboxä¸“é¡¹è®¾è®¡](../modules/Sandbox-Design.md)

### B. å‚è€ƒèµ„æ–™

- Manus Architecture Insights
- GenSpark Technical Blog
- Claude API Documentation
- FastAPI Best Practices
